YUI.add("moodle-atto_recordrtc-recording",function(e,t){e.M.atto_recordrtc=e.M.atto_recordrtc||{},function(){var e={},t=/([^&=]+)=?([^&]*)/g,n=function(e){return decodeURIComponent(e.replace(/\+/g," "))},r=window.location.search,i=t.exec(r.substring(1));while(i){e[n(i[1])]=n(i[2]);if(n(i[2])==="true"||n(i[2])==="false")e[n(i[1])]=n(i[2])==="true"?!0:!1;i=t.exec(r.substring(1))}window.params=e}();var n=null,r=null,i=null,s=null,o=null,u=null,a=null,f=null,l=null,c=null;e.M.atto_recordrtc.check_secure=function(){var e=window.location.protocol==="https:"||window.location.host.indexOf("localhost")!==-1;e||(window.alert(M.util.get_string("insecurealert","tinymce_recordrtc")),tinyMCEPopup.close())},e.M.atto_recordrtc.check_browser=function(){if(!(bowser.firefox&&bowser.version>=29||bowser.chrome&&bowser.version>=49||bowser.opera&&bowser.version>=36)){var e=document.querySelector("div[id=alert-warning]");e.parentElement.parentElement.classList.remove("hide")}},e.M.atto_recordrtc.captureUserMedia=function(e,t,n){navigator.mediaDevices.getUserMedia(e).then(t).catch(n)},e.M.atto_recordrtc.handleDataAvailable=function(e){l+=e.data.size,l>=c&&!localStorage.getItem("alerted")?(localStorage.setItem("alerted","true"),r.click(),window.alert(M.util.get_string("nearingmaxsize","tinymce_recordrtc"))):l>=c&&localStorage.getItem("alerted")==="true"?localStorage.removeItem("alerted"):f.push(e.data)},e.M.atto_recordrtc.startRecording=function(t,i){var u=null;t==="audio"?MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?u={audioBitsPerSecond:params.audiobitrate,mimeType:"audio/webm;codecs=opus"}:MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")&&(u={audioBitsPerSecond:params.audiobitrate,mimeType:"audio/ogg;codecs=opus"}):MediaRecorder.isTypeSupported("video/webm;codecs=vp9,opus")?u={audioBitsPerSecond:params.audiobitrate,videoBitsPerSecond:params.videobitrate,mimeType:"video/webm;codecs=vp9,opus"}:MediaRecorder.isTypeSupported("video/webm;codecs=h264,opus")?u={audioBitsPerSecond:params.audiobitrate,videoBitsPerSecond:params.videobitrate,mimeType:"video/webm;codecs=h264,opus"}:MediaRecorder.isTypeSupported("video/webm;codecs=vp8,opus")&&(u={audioBitsPerSecond:params.audiobitrate,videoBitsPerSecond:params.videobitrate,mimeType:"video/webm;codecs=vp8,opus"}),a=u?new MediaRecorder(i):new MediaRecorder(i,u),a.ondataavailable=e.M.atto_recordrtc.handleDataAvailable,a.start(1e3),n.muted=!0,s=params.timelimit,s++,r.innerHTML=M.util.get_string("stoprecording","tinymce_recordrtc")+' (<span id="minutes"></span>:<span id="seconds"></span>)',e.M.atto_recordrtc.setTime(),o=setInterval(e.M.atto_recordrtc.setTime,1e3),r.disabled=!1},e.M.atto_recordrtc.uploadToServer=function(t,r){var i=new XMLHttpRequest;i.open("GET",n.src,!0),i.responseType="blob",i.onload=function(){if(i.status===200){var n=this.response,s=(Math.random()*1e3).toString().replace(".","");t==="audio"?s+="-audio.ogg":s+="-video.webm";var o=new FormData;o.append("contextid",recordrtc.contextid),o.append("sesskey",parent.M.cfg.sesskey),o.append(t+"-filename",s),o.append(t+"-blob",n),e.M.atto_recordrtc.makeXMLHttpRequest("save.php",o,function(e,t){if(e==="upload-ended"){var n=location.href.replace(location.href.split("/").pop(),"")+"uploads.php/";r("ended",n+t)}else r(e)})}},i.send()},e.M.atto_recordrtc.makeXMLHttpRequest=function(e,t,n){var r=new XMLHttpRequest;r.onreadystatechange=function(){r.readyState===4&&r.status===200?n("upload-ended",r.responseText):r.status===404&&n("upload-failed-404")},r.upload.onprogress=function(e){n(Math.round(e.loaded/e.total*100)+"% "+M.util.get_string("uploadprogress","tinymce_recordrtc"))},r.upload.onerror=function(e){n("upload-failed",e)},r.upload.onabort=function(e){n("upload-aborted",e)},r.open("POST",e),r.send(t)},e.M.atto_recordrtc.pad=function(e){var t=e+"";return t.length<2?"0"+t:t},e.M.atto_recordrtc.setTime=function(){s--,r.querySelector("span#seconds").textContent=e.M.atto_recordrtc.pad(s%60),r.querySelector("span#minutes").textContent=e.M.atto_recordrtc.pad(parseInt(s/60)),s===0&&r.click()},e.M.atto_recordrtc.create_annotation=function(e,t){var n=window.prompt(M.util.get_string("annotationprompt","tinymce_recordrtc"),M.util.get_string("annotation:"+e,"tinymce_recordrtc"));if(!n)return undefined;var r='<div id="recordrtc_annotation" class="text-center"><a target="_blank" href="'+t+'">'+n+"</a></div>";return r},e.M.atto_recordrtc.insert_annotation=function(t,n){var r=e.M.atto_recordrtc.create_annotation(t,n);r?(tinyMCEPopup.editor.execCommand("mceInsertContent",!1,r),tinyMCEPopup.close()):i.textContent=M.util.get_string("attachrecording","tinymce_recordrtc")},e.M.atto_recordrtc.view_init=function(){n=document.querySelector("audio#player"),r=document.querySelector("button#start-stop"),i=document.querySelector("button#upload"),u="audio",c=parseInt(recordrtc.maxfilesize.match(/\d+/)[0])*Math.pow(1024,2),e.M.atto_recordrtc.check_secure(),e.M.atto_recordrtc.check_browser(),r.onclick=function(){var t=this;t.disabled=!0;if(t.textContent===M.util.get_string("startrecording","tinymce_recordrtc")||t.textContent===M.util.get_string("recordagain","tinymce_recordrtc")||t.textContent===M.util.get_string("recordingfailed","tinymce_recordrtc")){var s=document.querySelector("div[id=alert-danger]");s.parentElement.parentElement.classList.add("hide"),n.parentElement.parentElement.classList.add("hide"),i.parentElement.parentElement.classList.add("hide"),recordrtc.oldermoodle||(r.classList.remove("btn-outline-danger"),r.classList.add("btn-danger")),f=[],l=0;var a={onMediaCaptured:function(e){t.stream=e,t.mediaCapturedCallback&&t.mediaCapturedCallback()},onMediaStopped:function(e){t.textContent=e},onMediaCapturingFailed:function(e){var t=null;if(e.name==="PermissionDeniedError"&&bowser.firefox)InstallTrigger.install({Foo:{URL:"https://addons.mozilla.org/en-US/firefox/addon/enable-screen-capturing/",toString:function(){return this.URL}}}),t=M.util.get_string("startrecording","tinymce_recordrtc");else if(e.name==="DevicesNotFoundError"||
e.name==="NotFoundError"){var n=document.querySelector("div[id=alert-danger]");n.parentElement.parentElement.classList.remove("hide"),n.textContent=M.util.get_string("inputdevicealert_title","tinymce_recordrtc")+" "+M.util.get_string("inputdevicealert","tinymce_recordrtc"),t=M.util.get_string("recordingfailed","tinymce_recordrtc")}a.onMediaStopped(t)}};e.M.atto_recordrtc.captureAudio(a),t.mediaCapturedCallback=function(){e.M.atto_recordrtc.startRecording(u,t.stream)}}else clearInterval(o),setTimeout(function(){t.disabled=!1},1e3),e.M.atto_recordrtc.stopRecording(t.stream),t.textContent=M.util.get_string("recordagain","tinymce_recordrtc"),recordrtc.oldermoodle||(r.classList.remove("btn-danger"),r.classList.add("btn-outline-danger"))}},e.M.atto_recordrtc.captureAudio=function(t){e.M.atto_recordrtc.captureUserMedia({audio:!0},function(e){n.srcObject=e,t.onMediaCaptured(e)},function(e){t.onMediaCapturingFailed(e)})},e.M.atto_recordrtc.stopRecording=function(t){a.stop(),t.getTracks().forEach(function(e){e.stop()});var r=new Blob(f);n.src=URL.createObjectURL(r),n.muted=!1,n.controls=!0,n.parentElement.parentElement.classList.remove("hide"),i.parentElement.parentElement.classList.remove("hide"),i.textContent=M.util.get_string("attachrecording","tinymce_recordrtc"),i.disabled=!1,i.onclick=function(){if(!n.src||f===[])return window.alert(M.util.get_string("norecordingfound","tinymce_recordrtc"));var t=i;return t.disabled=!0,e.M.atto_recordrtc.uploadToServer(u,function(n,r){n==="ended"?(t.disabled=!1,e.M.atto_recordrtc.insert_annotation(u,r)):n==="upload-failed"?(t.disabled=!1,t.textContent=M.util.get_string("uploadfailed","tinymce_recordrtc")+" "+r):n==="upload-failed-404"?(t.disabled=!1,t.textContent=M.util.get_string("uploadfailed404","tinymce_recordrtc")):n==="upload-aborted"?(t.disabled=!1,t.textContent=M.util.get_string("uploadaborted","tinymce_recordrtc")+" "+r):t.textContent=n}),undefined}},e.M.atto_recordrtc.view_init=function(){n=document.querySelector("video#player"),r=document.querySelector("button#start-stop"),i=document.querySelector("button#upload"),u="video",c=parseInt(recordrtc.maxfilesize.match(/\d+/)[0])*Math.pow(1024,2),e.M.atto_recordrtc.check_secure(),e.M.atto_recordrtc.check_browser(),r.onclick=function(){var t=this;t.disabled=!0;if(t.textContent===M.util.get_string("startrecording","tinymce_recordrtc")||t.textContent===M.util.get_string("recordagain","tinymce_recordrtc")||t.textContent===M.util.get_string("recordingfailed","tinymce_recordrtc")){var s=document.querySelector("div[id=alert-danger]");s.parentElement.parentElement.classList.add("hide"),i.parentElement.parentElement.classList.add("hide"),recordrtc.oldermoodle||(r.classList.remove("btn-outline-danger"),r.classList.add("btn-danger")),f=[],l=0;var a={onMediaCaptured:function(e){t.stream=e,t.mediaCapturedCallback&&t.mediaCapturedCallback()},onMediaStopped:function(e){t.textContent=e},onMediaCapturingFailed:function(e){var t=null;if(e.name==="PermissionDeniedError"&&bowser.firefox)InstallTrigger.install({Foo:{URL:"https://addons.mozilla.org/en-US/firefox/addon/enable-screen-capturing/",toString:function(){return this.URL}}}),t=M.util.get_string("startrecording","tinymce_recordrtc");else if(e.name==="DevicesNotFoundError"||e.name==="NotFoundError"){var n=document.querySelector("div[id=alert-danger]");n.parentElement.parentElement.classList.remove("hide"),n.textContent=M.util.get_string("inputdevicealert","tinymce_recordrtc")+" "+M.util.get_string("inputdevicealert","tinymce_recordrtc"),t=M.util.get_string("recordingfailed","tinymce_recordrtc")}a.onMediaStopped(t)}};n.parentElement.parentElement.classList.remove("hide"),n.controls=!1,e.M.atto_recordrtc.captureAudioVideo(a),t.mediaCapturedCallback=function(){e.M.atto_recordrtc.startRecording(u,t.stream)}}else clearInterval(o),setTimeout(function(){t.disabled=!1},1e3),e.M.atto_recordrtc.stopRecording(t.stream),t.textContent=M.util.get_string("recordagain","tinymce_recordrtc"),recordrtc.oldermoodle||(r.classList.remove("btn-danger"),r.classList.add("btn-outline-danger"))}},e.M.atto_recordrtc.captureAudioVideo=function(t){e.M.atto_recordrtc.captureUserMedia({audio:!0,video:{width:{ideal:640},height:{ideal:480}}},function(e){n.srcObject=e,n.play(),t.onMediaCaptured(e)},function(e){t.onMediaCapturingFailed(e)})},e.M.atto_recordrtc.stopRecording=function(t){a.stop(),t.getTracks().forEach(function(e){e.stop()});var r=new Blob(f);n.src=URL.createObjectURL(r),n.muted=!1,n.controls=!0,i.parentElement.parentElement.classList.remove("hide"),i.textContent=M.util.get_string("attachrecording","tinymce_recordrtc"),i.disabled=!1,i.onclick=function(){if(!n.src||f===[])return window.alert(M.util.get_string("norecordingfound","tinymce_recordrtc"));var t=i;return t.disabled=!0,e.M.atto_recordrtc.uploadToServer(u,function(n,r){n==="ended"?(t.disabled=!1,e.M.atto_recordrtc.insert_annotation(u,r)):n==="upload-failed"?(t.disabled=!1,t.textContent=M.util.get_string("uploadfailed","tinymce_recordrtc")+" "+r):n==="upload-failed-404"?(t.disabled=!1,t.textContent=M.util.get_string("uploadfailed404","tinymce_recordrtc")):n==="upload-aborted"?(t.disabled=!1,t.textContent=M.util.get_string("uploadaborted","tinymce_recordrtc")+" "+r):t.textContent=n}),undefined}}},"@VERSION@",{requires:[]});
